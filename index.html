<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VIX Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    .result { margin-top: 20px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    p { margin: 0.5em 0; }
  </style>
</head>
<body>
  <h1>üìà VIX Dashboard</h1>
  <button onclick="fetchVIXData()">üîÑ Update VIX Data</button>
  <div class="result" id="vixResults">Loading...</div>

  <script>
    const API_KEY = '2248f0c8a4de4025846b3093bdd1d641';

    const holidays = [
      "2025-01-01", "2025-01-20", "2025-02-17", "2025-04-18", "2025-05-26",
      "2025-07-04", "2025-09-01", "2025-11-27", "2025-12-25"
    ];

    function getLastMarketDate(referenceDate = new Date(), shift = 1) {
      const date = new Date(referenceDate);
      let tries = 0;

      while (tries < 10) {
        date.setDate(date.getDate() - shift);
        const day = date.getDay(); // 0=Sun, 6=Sat
        const yyyyMMdd = date.toISOString().split('T')[0];

        if (day !== 0 && day !== 6 && !holidays.includes(yyyyMMdd)) {
          return yyyyMMdd;
        }
        tries++;
      }
      return null;
    }

    function formatDate(d) {
      return d.toISOString().split("T")[0];
    }

    async function fetchVIXData() {
      const resultsEl = document.getElementById("vixResults");
      resultsEl.innerText = "Fetching VIX data...";

      const today = new Date();
      const todayStr = formatDate(today);
      const yestStr = getLastMarketDate(today, 1);

      const apiUrl = `https://api.twelvedata.com/time_series?symbol=VIX&interval=1min&outputsize=5000&apikey=${API_KEY}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (!data.values) {
          resultsEl.innerText = `‚ùå Error loading data: ${data.message || "Unknown error."}`;
          return;
        }

        const values = data.values;

        function findTime(dateStr, timeStr) {
          return values.find(v => v.datetime.startsWith(dateStr) && v.datetime.endsWith(timeStr));
        }

        const tOpen = findTime(todayStr, '09:30:00');
        const yOpen = findTime(yestStr, '09:30:00');
        const yClose = findTime(yestStr, '16:00:00');

        if (!tOpen || !yOpen || !yClose) {
          resultsEl.innerText = "‚ö†Ô∏è Data not available yet (may be too early or market was closed).";
          return;
        }

        const tOpenVal = parseFloat(tOpen.open);
        const yOpenVal = parseFloat(yOpen.open);
        const yCloseVal = parseFloat(yClose.close);

        const diffOpen = (yOpenVal - tOpenVal).toFixed(2);
        const diffClose = (yCloseVal - tOpenVal).toFixed(2);

        resultsEl.innerHTML = `
          <p><strong>Today's Open (9:30 AM):</strong> ${tOpenVal}</p>
          <p><strong>Yesterday's Open (${yestStr}):</strong> ${yOpenVal}</p>
          <p><strong>Yesterday's Close (${yestStr} 4:00 PM):</strong> ${yCloseVal}</p>
          <hr>
          <p><strong>Yesterday Open - Today Open:</strong> ${diffOpen}</p>
          <p><strong>Yesterday Close - Today Open:</strong> ${diffClose}</p>
        `;
      } catch (error) {
        resultsEl.innerText = "‚ùå Network error or CORS blocked the request.";
        console.error(error);
      }
    }

    fetchVIXData();
  </script>
</body>
</html>
