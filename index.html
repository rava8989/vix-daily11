 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIX Strategy Helper</title>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: row;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      padding: 15px;
      border-right: 1px solid #ccc;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .sidebar h2 { font-size: 16px; margin-top: 0; }
    .sidebar ul { padding-left: 18px; margin-top: 6px; margin-bottom: 18px; }

    .sidebar details summary {
      cursor: pointer;
      padding: 8px 0;
      font-size: 16px;
    }
    .sidebar details { user-select: none; }

    .main { flex: 1; text-align: center; padding: 20px; }

    /* Calculator row with left checkboxes */
    .calcRow {
      display: flex;
      gap: 12px;
      align-items: stretch;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .winrateBox {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 5px #ccc;
      padding: 12px;
      width: 220px;
      text-align: left;
      box-sizing: border-box;
    }
    .winrateBox h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }
    .winrateBox label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      font-size: 14px;
      cursor: pointer;
    }
    .winrateBox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .calculator {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px #ccc;
      max-width: 300px;
      width: 300px;
      box-sizing: border-box;
    }

    label { display: block; margin-top: 10px; }
    input { width: 100%; margin-top: 5px; margin-bottom: 10px; }
    input:disabled { opacity: 0.6; cursor: not-allowed; }
    button { width: 100%; padding: 8px; margin-top: 10px; }

    /* Unified recommendation block */
    #recBlock {
      margin: 20px auto 6px auto;
      padding: 15px;
      max-width: 880px;
      border-radius: 8px;
      box-shadow: 0 0 5px #ccc;
      color: #333;
      text-align: left;
      line-height: 1.35;
      font-size: 28px;
      background: #eee;
    }
    #recBlock .row { margin: 6px 0; }
    #recBlock .mainline { font-weight: bold; }

    /* small label under results */
    #resultDayLabel {
      max-width: 880px;
      margin: 0 auto 10px auto;
      text-align: right;
      font-size: 12px;
      color: #888;
    }

    .flowchart { margin: 20px auto; max-width: 100%; overflow-x: auto; }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      border: 1px solid #ccc;
      color: #555;
      margin-left: 6px;
      background: #fafafa;
    }

    /* Bottom strategy section */
    .strategy-doc {
      background: #fff;
      padding: 20px;
      margin: 20px auto 60px auto;
      max-width: 900px;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
      text-align: left;
      line-height: 1.5;
    }
    .strategy-doc h2 { font-size: 20px; margin: 0 0 10px 0; }
    .strategy-doc h3 { font-size: 16px; margin: 18px 0 8px 0; color: #333; }
    .strategy-doc ul { margin: 6px 0 12px 22px; }
    .strategy-doc li { margin: 2px 0; }

    .muted-note { font-size: 12px; color: #666; margin-top: 6px; }
    .divider { margin: 16px 0; text-align: center; color: #999; letter-spacing: 2px; }

    .crossed { text-decoration: line-through; color: #999; }

    .strategy-image { margin: 12px 0 6px 0; }
    .strategy-image img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 8px 0 0 0;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
    }

    /* ---------- Mobile improvements ---------- */
    @media (max-width: 900px) {
      body { flex-direction: column; }

      .sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid #ccc;
        box-shadow: none;
        position: static;
        overflow: visible;
      }

      .main { padding: 12px; }

      .calculator {
        max-width: 100%;
        width: 100%;
        margin: 0 auto 12px auto;
      }

      .winrateBox {
        width: 100%;
        max-width: 520px;
      }

      #recBlock {
        max-width: 100%;
        font-size: 20px;
        padding: 12px;
      }

      #resultDayLabel {
        max-width: 100%;
        padding: 0 2px;
      }

      .strategy-doc {
        max-width: 100%;
        margin: 12px auto 40px auto;
        padding: 14px;
      }

      input, button {
        font-size: 16px; /* prevents iOS zoom */
        padding: 10px;
      }

      .strategy-doc, #recBlock { word-break: break-word; }
    }
  </style>
</head>

<body>

  <div class="sidebar">
    <!-- schedules collapse on mobile by JS -->
    <details id="scheduleDetails">
      <summary><strong>Schedules</strong></summary>

      <h2>CPI Schedule</h2>
      <ul id="cpiSchedule"></ul>

      <h2>Fed Day Schedule</h2>
      <ul id="fedSchedule"></ul>

      <h2>OPEX Days</h2>
      <ul id="opexSchedule"></ul>

      <h2>Market Holidays</h2>
      <ul id="holidaySchedule"></ul>

      <h2>VIX Expiration</h2>
      <ul id="vixExpirySchedule"></ul>
    </details>
  </div>

  <div class="main">

    <div class="calcRow">
      <!-- Win rate checkboxes -->
      <div class="winrateBox">
        <h3>Win rate override (previous day)</h3>

        <label>
          <input type="checkbox" id="winrate90" />
          M8BF win rate &gt; 90%
        </label>

        <label>
          <input type="checkbox" id="winrate0" />
          M8BF win rate = 0%
        </label>
      </div>

      <!-- Calculator -->
      <div class="calculator">
        <h1>VIX Calculator</h1>

        <label>VIX Today’s Open:
          <input type="number" id="todayOpen" step="0.01" />
        </label>

        <label>VIX Yesterday’s Open:
          <input type="number" id="yesterdayOpen" step="0.01" />
        </label>

        <label>VIX Yesterday’s Close:
          <input type="number" id="yesterdayClose" step="0.01" />
        </label>

        <button onclick="calculateStrategy()">Calculate</button>
      </div>
    </div>

    <div style="margin-top: 10px; font-size: 14px; text-align: center;">
      <p>
        <strong>Overnight VIX Drop:</strong>
        <span id="overnightDropDisplay">—</span>
        <span id="cpiTag" class="tag" style="display:none;">CPI day</span>
        <span id="fedTag" class="tag" style="display:none;">Fed day</span>
        <span id="opexTag" class="tag" style="display:none;">OPEX</span>
        <span id="postOpexTag" class="tag" style="display:none;">Post-OPEX</span>
        <span id="postHolidayTag" class="tag" style="display:none;">Post-Holiday</span>
        <span id="eomTag" class="tag" style="display:none;">EOM</span>
      </p>
      <p>
        <strong>Yesterday’s VIX Open − Today’s VIX Open:</strong>
        <span id="openDiffDisplay">—</span>
        <span id="openDiffNote" class="tag" style="display:none;">ignored on CPI day</span>
      </p>
    </div>

    <div style="text-align: right;">
      <div id="todayDate" style="font-size: 14px; color: #666; margin-bottom: 2px;"></div>
      <div id="dayLabel" style="font-size: 12px; color: #888; margin-bottom: 5px;"></div>
    </div>

    <div id="recBlock">
      <div class="row mainline" id="mainRec">—</div>
      <div class="row" id="bobfLine">—</div>
    </div>

    <!-- day label under calculator results -->
    <div id="resultDayLabel">—</div>

    <!-- FLOWCHART (UNCHANGED) -->
    <div class="flowchart">
      <div class="mermaid">
flowchart TD
  A["SPX overnight gap < 0.9%?"]
  A -->|No| M1["M8 Butterfly"]
  A -->|Yes| D["Overnight VIX drop > 0.65?"]
  D -->|Yes| Y["GXBF @ 9:36 AM"]
  D -->|No| C["Open-to-open VIX > 1.4?"]
  C -->|Yes| M2["M8 Butterfly"]
  C -->|No| F["Overnight VIX drop 0.01–0.65?"]
  F -->|Yes| S["Straddle @ 9:32 AM"]
  F -->|No| M3["M8 Butterfly"]

  class M1,M2,M3 butterfly
  class Y atm
  class S straddle

  classDef butterfly fill:#b49aff,stroke:#333,stroke-width:1px
  classDef straddle fill:#61f7d6,stroke:#333,stroke-width:1px
  classDef atm fill:#fff399,stroke:#333,stroke-width:1px
      </div>
    </div>

    <!-- OVERVIEW -->
    <section class="strategy-doc" id="strategy-doc">
      <h2>Sigma 3 — SPX 0DTE Strategy Overview</h2>

      <p>
        Sigma 3 consists of four SPX 0DTE strategies:
        <strong>M8 Butterfly (M8BF)</strong>,
        <strong>Straddle</strong>,
        <strong>GXBF (GEX Butterfly)</strong>,
        and <strong>BOBF</strong>.
        Each strategy has its own entry rules, risk limits, and calendar filters.
        The VIX calculator determines which strategies are valid on any given day
        based on overnight VIX behavior and market conditions.
      </p>

      <div class="divider">⸻</div>

      <h3>M8 Butterfly (M8BF)</h3>
      <ul>
        <li>Used when overnight VIX is <strong>up</strong>.</li>
        <li>Triggered when <strong>open-to-open VIX &gt; 1.4</strong>, or when overnight VIX does not meet straddle or GXBF thresholds.</li>
        <li><strong>Not traded</strong> on Fed days.</li>
        <li><strong>Not traded</strong> on the first trading day after a market holiday (unless overridden by NM rule).</li>
       <li><strong>Not traded</strong> on the 6 major earnings release days: MSFT, META, GOOG, AMZN, AAPL, NVDA.</li
       <li>On the first trading day of the month (NM), M8BF converts to <strong>NM Straddle</strong> (not on Mondays).</li>
        <li>Post-OPEX Monday note: when M8BF appears, afternoon timing is preferred.</li>
        <li>Max risk: <strong>$1,400</strong>.</li>
        <li>Use center strike from M8 prediction. Adjust the wings until you reach a cost of approximately $14 for entry.</li>
      </ul>
      <div class="strategy-image">
        <img src="./M8BF.jpg" alt="M8BF" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <h3>Straddle</h3>
      <ul>
        <li>Used when overnight VIX is <strong>moderately down</strong> (<strong>0.01 – 0.65</strong>).</li>
        <li>Entry time: <strong>9:32 AM</strong>.</li>
        <li><strong>Not traded</strong> on OPEX days.</li>
        <li>On Wednesdays (non-Fed, non-CPI), straddles convert to M8BF unless overridden.</li>
        <li><strong>End-of-Month (EOM):</strong> automatic <strong>EOM Straddle</strong>.</li>
        <li>EOM Straddle max risk: <strong>$3,500</strong>.</li>
      </ul>
      <div class="strategy-image">
        <img src="./Straddle.jpg" alt="Straddle payoff diagram" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <h3>GXBF (GEX Butterfly)</h3>
      <ul>
        <li>Used when overnight VIX is <strong>strongly down</strong> (<strong>&gt; 0.65</strong>).</li>
        <li>Takes priority over open-to-open VIX logic.</li>
        <li>Entry time: <strong>9:36 AM</strong>, centered on major positive gamma.</li>
        <li>Allowed on Fed days.</li>
       <li>Automatic GXBF on OPEX+1.</li>
        <li>Max risk: <strong>$1,400</strong>.</li>
      </ul>
      <div class="strategy-image">
        <img src="./gex.jpg" alt="GXBF strategy visual" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <h3>BOBF</h3>
      <ul>
        <li><strong>https://optionomega.com/share/gd2bRi16syr3R1UaGVUE.</li>
       <li><strong>Not traded</strong> on the 6 major earnings release days: MSFT, META, GOOG, AMZN, AAPL, NVDA.</li>
        <li><strong>Not traded</strong> on monthly VIX expiration days.</li>
        <li><strong>Not traded</strong> on OPEX-1.</li>
        <li><strong>Not traded</strong> on EOM-2 and EOM-1.</li>
        <li><strong>Not traded</strong> on the first trading Monday of the month (NM Monday).</li>
        <li>Maximum VIX allowed: <strong>23</strong>.</li>
         <li>Modified version traded on Fridays</li>
       <li>https://optionomega.com/share/cVLL2DfdpiGiLekplKPs</li>
      
      </ul>
      <div class="strategy-image">
        <img src="./BOBF.jpg" alt="BOBF strategy visual" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <h3>CPI Rule</h3>
      <ul>
        <li>Uses only <strong>Yesterday’s VIX Close − Today’s VIX Open</strong>.</li>
        <li>If VIX is <strong>down</strong>: trade <strong>Long ATM Call @ 9:32 AM</strong>.</li>
        <li>Max entry premium: <strong>$13</strong>.</li>
        <li>If VIX is up: <strong>No trade</strong>.</li>
      </ul>

      <div class="divider">⸻</div>

      <h3>NM & EOM Straddles</h3>
      <ul>
        <li><strong>NM Straddle</strong> is used on the <strong>first trading day of the month</strong> except when it falls on Mondays.</li>
        <li><strong>EOM Straddle</strong> is used on the <strong>last trading day of the month</strong>.</li>
        <li>Both setups use the standard <strong>9:32 AM Straddle</strong>.</li>
        <li>These are calendar-driven trades with historically strong behavior.</li>
        <li><strong>NM Straddle max risk: $3,200.</strong></li>
        <li><strong>EOM Straddle max risk: $3,500.</strong></li>
      </ul>

      <div class="divider">⸻</div>

      <h3>Win Rate Rules</h3>
      <ul>
        <li>If <strong>M8BF win rate was &gt; 90%</strong> the previous day, the next day’s <strong>Straddle signal</strong> is replaced with <strong>M8BF</strong>.</li>
        <li>If <strong>M8BF win rate was 0%</strong> the previous day, the next day is an <strong>automatic Straddle</strong> (BOBF can still be in play if not blocked by its filters).</li>
      </ul>

      <div class="divider">⸻</div>

      <h3>P/L</h3>
      <ul>
        <li>P/L from September 1st 2024 to February 1st 2026</li>
      </ul>
      <div class="strategy-image">
        <img src="./pl.jpg" alt="P/L" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <ul>
        <li>Winrate for the last 2 digits of the center strike M8BF prediction. AM vs PM. Avoid low win rate strikes.</li>
      </ul>
      <div class="strategy-image">
        <img src="./last.jpg" alt="Last 2 digits win rate" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <!-- Raw stats -->
      <h3>Raw stats</h3>
      <div class="strategy-image">
        <img src="./11.jpg" alt="Raw stats 1" loading="lazy" />
      </div>
      <div class="strategy-image">
        <img src="./22.jpg" alt="Raw stats 2" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <ul>
        <li>Optional modification for M8BF: some strike can be changed.</li>
      </ul>
      <div class="strategy-image">
        <img src="./move.jpg" alt="Optional M8BF modification" loading="lazy" />
      </div>

      <div class="divider">⸻</div>

      <p>All trades are held to expiration.</p>

      <p class="muted-note">
        <strong>Disclaimer:</strong> This content is for informational and educational purposes only and does not constitute financial or investment advice. Trading options involves significant risk.
      </p>
    </section>

  </div>

  <script>
    /* ===== SCHEDULES ===== */

    const cpiSchedule = [
      "January 13, 2026",
      "February 13, 2026",
      "March 11, 2026",
      "April 10, 2026",
      "May 12, 2026",
      "June 10, 2026",
      "July 14, 2026",
      "August 12, 2026",
      "September 11, 2026",
      "October 14, 2026",
      "November 10, 2026",
      "December 10, 2026"
    ];

    const fedSchedule = [
      "January 28, 2026",
      "March 18, 2026",
      "April 29, 2026",
      "June 17, 2026",
      "July 29, 2026",
      "September 16, 2026",
      "October 28, 2026",
      "December 9, 2026"
    ];

    const opexSchedule = [
      "January 16, 2026",
      "February 20, 2026",
      "March 20, 2026",
      "April 17, 2026",
      "May 15, 2026",
      "June 18, 2026",
      "July 17, 2026",
      "August 21, 2026",
      "September 18, 2026",
      "October 16, 2026",
      "November 20, 2026",
      "December 18, 2026"
    ];

    const marketHolidays = [
      "January 1, 2026",
      "January 19, 2026",
      "February 16, 2026",
      "April 3, 2026",
      "May 25, 2026",
      "June 19, 2026",
      "July 3, 2026",
      "September 7, 2026",
      "November 26, 2026",
      "December 25, 2026"
    ];

    const vixExpirySchedule = [
      "January 21, 2026",
      "February 18, 2026",
      "March 18, 2026",
      "April 15, 2026",
      "May 20, 2026",
      "June 17, 2026",
      "July 15, 2026",
      "August 19, 2026",
      "September 16, 2026",
      "October 21, 2026",
      "November 18, 2026",
      "December 16, 2026"
    ];

    /* ===== RENDER SCHEDULES ===== */

    function renderSchedule(list, ulId) {
      const ul = document.getElementById(ulId);
      list.forEach(date => {
        const li = document.createElement('li');
        li.textContent = date;
        li.setAttribute('data-date', date);
        ul.appendChild(li);
      });
    }

    renderSchedule(cpiSchedule, 'cpiSchedule');
    renderSchedule(fedSchedule, 'fedSchedule');
    renderSchedule(opexSchedule, 'opexSchedule');
    renderSchedule(marketHolidays, 'holidaySchedule');
    renderSchedule(vixExpirySchedule, 'vixExpirySchedule');

    /* ===== MOBILE: COLLAPSE SCHEDULES BY DEFAULT ===== */
    document.addEventListener("DOMContentLoaded", () => {
      const details = document.getElementById("scheduleDetails");
      if (!details) return;

      const mq = window.matchMedia("(max-width: 900px)");

      const apply = () => {
        if (mq.matches) details.removeAttribute("open");     // collapsed on mobile
        else details.setAttribute("open", "");               // open on desktop
      };

      apply();

      if (mq.addEventListener) mq.addEventListener("change", apply);
      else mq.addListener(apply); // older Safari
    });

    /* ===== WIN RATE CHECKBOX MUTUAL EXCLUSION ===== */

    const winrate90 = document.getElementById('winrate90');
    const winrate0  = document.getElementById('winrate0');

    function enforceMutualExclusion(changed) {
      if (changed === '90' && winrate90.checked) winrate0.checked = false;
      if (changed === '0'  && winrate0.checked)  winrate90.checked = false;
    }

    winrate90.addEventListener('change', () => enforceMutualExclusion('90'));
    winrate0.addEventListener('change', () => enforceMutualExclusion('0'));

    /* ===== CROSS OFF PAST DATES ===== */

    function hasPassed(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return false;
      const endOfDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);
      return new Date() > endOfDay;
    }

    function crossOffPastDates(ulId) {
      const ul = document.getElementById(ulId);
      if (!ul) return;
      Array.from(ul.children).forEach(li => {
        const dateText = li.getAttribute('data-date') || li.textContent.trim();
        if (hasPassed(dateText)) li.classList.add('crossed');
      });
    }

    function refreshCrossedDates() {
      crossOffPastDates('cpiSchedule');
      crossOffPastDates('fedSchedule');
      crossOffPastDates('opexSchedule');
      crossOffPastDates('holidaySchedule');
      crossOffPastDates('vixExpirySchedule');
    }

    document.addEventListener('DOMContentLoaded', () => {
      refreshCrossedDates();
      const now = new Date();
      const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 2);
      setTimeout(() => {
        refreshCrossedDates();
        setInterval(refreshCrossedDates, 24 * 60 * 60 * 1000);
      }, midnight - now);
    });

    /* ===== DATE HELPERS ===== */

    function todayLongUS() {
      return new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }
    function isCpiDay()      { return cpiSchedule.includes(todayLongUS()); }
    function isFedDay()      { return fedSchedule.includes(todayLongUS()); }
    function isOpexDay()     { return opexSchedule.includes(todayLongUS()); }
    function isVixExpiryDay(){ return vixExpirySchedule.includes(todayLongUS()); }

    function isWeekend(d) { const day = d.getDay(); return day === 0 || day === 6; }
    function isHoliday(d) {
      const asLong = d.toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
      return marketHolidays.includes(asLong);
    }
    function isTradingDay(d) { return !isWeekend(d) && !isHoliday(d); }

    function nextTradingDay(d) {
      const nd = new Date(d);
      do { nd.setDate(nd.getDate() + 1); } while (isWeekend(nd) || isHoliday(nd));
      return nd;
    }
    function prevTradingDay(d) {
      const pd = new Date(d);
      do { pd.setDate(pd.getDate() - 1); } while (isWeekend(pd) || isHoliday(pd));
      return pd;
    }
    function isTodayFirstTradingDayAfter(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return false;
      const after = nextTradingDay(d);
      const today = new Date();
      return after.getFullYear() === today.getFullYear()
          && after.getMonth() === today.getMonth()
          && after.getDate() === today.getDate();
    }
    function isPostHoliday() { return marketHolidays.some(isTodayFirstTradingDayAfter); }
    function isPostOpexMonday() {
      const postAnyOpex = opexSchedule.some(isTodayFirstTradingDayAfter);
      return postAnyOpex && new Date().getDay() === 1;
    }

    // EOM detection (last TRADING day of month)
    function isLastTradingDayOfMonth(date = new Date()) {
      const next = nextTradingDay(date);
      return next.getMonth() !== date.getMonth();
    }
    function isEomMinusN(n, date = new Date()) {
      const firstNextMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);
      const eom = prevTradingDay(firstNextMonth);
      let target = new Date(eom);
      for (let i = 0; i < n; i++) target = prevTradingDay(target);
      return target.getFullYear() === date.getFullYear()
          && target.getMonth() === date.getMonth()
          && target.getDate() === date.getDate();
    }
    function isTodayTradingDayBefore(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return false;
      const before = prevTradingDay(d);
      const today = new Date();
      return before.getFullYear() === today.getFullYear()
          && before.getMonth() === today.getMonth()
          && before.getDate() === today.getDate();
    }

    // NM detection (first trading day of month)
    function isFirstTradingDayOfMonth(date = new Date()) {
      const prev = prevTradingDay(date);
      return prev.getMonth() !== date.getMonth();
    }

    // first trading Monday of the month (NM Monday)
    function isFirstTradingMondayOfMonth(date = new Date()) {
      const year = date.getFullYear();
      const month = date.getMonth();

      // start at the 1st and move to first trading day
      let d = new Date(year, month, 1);
      while (isWeekend(d) || isHoliday(d)) d.setDate(d.getDate() + 1);

      // move forward until we hit a Monday trading day
      while (d.getDay() !== 1) {
        d = nextTradingDay(d);
      }

      return d.getFullYear() === year && d.getMonth() === month && d.getDate() === date.getDate();
    }

    /* ===== TRADING LABEL (AUTO UNDER TODAY'S DATE, NO CALCULATOR NEEDED) ===== */

    function ordinal(n) {
      const s = ["th","st","nd","rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function weekdayName(dow) {
      return ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dow] || "";
    }

    // Example output: "1st Monday", "2nd Tuesday", etc. (counts trading weekdays only)
    function tradingWeekdayOrdinalLabel(date = new Date()) {
      const target = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const dow = target.getDay();
      const monthStart = new Date(target.getFullYear(), target.getMonth(), 1);

      let count = 0;
      for (let d = new Date(monthStart); d <= target; d.setDate(d.getDate() + 1)) {
        if (!isTradingDay(d)) continue;
        if (d.getDay() === dow) count++;
      }

      // if today isn't a trading day, still show which weekday it is
      if (!isTradingDay(target)) {
        return `${weekdayName(dow)} (market closed)`;
      }

      return `${ordinal(count)} ${weekdayName(dow)}`;
    }

    function updateDateHeader() {
      document.getElementById('todayDate').textContent =
        "Today’s Date: " + new Date().toLocaleDateString();
      document.getElementById('dayLabel').textContent =
        tradingWeekdayOrdinalLabel(new Date());
    }

    /* ===== UI INIT ===== */

    function updateCpiUI() {
      const cpi = isCpiDay();
      document.getElementById('yesterdayOpen').disabled = cpi;
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateCpiUI();
      updateDateHeader();

      // initialize the label under results (so it shows even before Calculate)
      const resultLbl = document.getElementById("resultDayLabel");
      if (resultLbl) resultLbl.textContent = tradingWeekdayOrdinalLabel(new Date());

      // refresh date label after midnight
      const now = new Date();
      const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 2);
      setTimeout(() => {
        updateDateHeader();
        const resultLbl2 = document.getElementById("resultDayLabel");
        if (resultLbl2) resultLbl2.textContent = tradingWeekdayOrdinalLabel(new Date());
        setInterval(() => {
          updateDateHeader();
          const resultLbl3 = document.getElementById("resultDayLabel");
          if (resultLbl3) resultLbl3.textContent = tradingWeekdayOrdinalLabel(new Date());
        }, 24 * 60 * 60 * 1000);
      }, midnight - now);
    });

    /* ===== MAIN CALCULATOR ===== */

    function calculateStrategy() {
      const today = parseFloat(document.getElementById('todayOpen').value);
      const yOpen = parseFloat(document.getElementById('yesterdayOpen').value);
      const yClose = parseFloat(document.getElementById('yesterdayClose').value);

      if (isNaN(today) || isNaN(yClose) || (!isCpiDay() && isNaN(yOpen))) {
        alert("Please enter valid numbers.");
        return;
      }

      const winrateHigh = winrate90.checked; // M8BF win rate >90%
      const winrateZero = winrate0.checked;  // M8BF win rate =0%

      const now = new Date();
      const dayOfWeek = now.getDay();
      const isMonday = dayOfWeek === 1;
      const isFriday = dayOfWeek === 5;
      const isWednesday = dayOfWeek === 3;

      const nmToday = isFirstTradingDayOfMonth(now);
      const nmMonday = isFirstTradingMondayOfMonth(now);

      const cpiToday = isCpiDay();
      const fedToday = isFedDay();
      const opexToday = isOpexDay();
      const postHoliday = isPostHoliday();
      const postOpexMonday = isPostOpexMonday();
      const postOpexDay = opexSchedule.some(isTodayFirstTradingDayAfter);
      const eomTradingDay = isLastTradingDayOfMonth(now);
      const eomMinus1 = isEomMinusN(1, now);
      const eomMinus2 = isEomMinusN(2, now);
      const vixExpiryToday = isVixExpiryDay();

      const opexMinus1 = opexSchedule.some(isTodayTradingDayBefore);

      // context tags
      document.getElementById('cpiTag').style.display = cpiToday ? 'inline-block' : 'none';
      document.getElementById('fedTag').style.display = fedToday ? 'inline-block' : 'none';
      document.getElementById('opexTag').style.display = opexToday ? 'inline-block' : 'none';
      document.getElementById('postOpexTag').style.display = postOpexDay ? 'inline-block' : 'none';
      document.getElementById('postHolidayTag').style.display = postHoliday ? 'inline-block' : 'none';
      document.getElementById('eomTag').style.display = eomTradingDay ? 'inline-block' : 'none';

      const openDiff = (isNaN(yOpen) ? NaN : yOpen - today);
      const overnightDrop = yClose - today; // yClose - todayOpen

      document.getElementById('overnightDropDisplay').textContent =
        isNaN(overnightDrop) ? '—' : overnightDrop.toFixed(2);

      const openDiffDisplay = document.getElementById('openDiffDisplay');
      const openDiffNote = document.getElementById('openDiffNote');
      if (cpiToday) {
        openDiffDisplay.textContent = '—';
        openDiffNote.style.display = 'inline-block';
      } else {
        openDiffNote.style.display = 'none';
        openDiffDisplay.textContent = isNaN(openDiff) ? '—' : openDiff.toFixed(2);
      }

      let recommendation = "";
      let bgColor = "#eee";
      let crossedMain = false;
      let addPostOpexNote = false;

      if (cpiToday) {
        // CPI rule: if VIX down (yClose - todayOpen > 0) => long call, else no trade
        if (overnightDrop > 0) {
          recommendation = "Long ATM Call @ 9:32 AM (CPI day) — Max entry premium $13";
          bgColor = "#61f7d6";
        } else {
          recommendation = "No M8BF (CPI day — VIX up)";
          bgColor = "#eee";
          crossedMain = true;
        }
      } else {
        // Base logic
        if (overnightDrop > 0.65) {
          recommendation = "GXBF @ 9:36 AM";
          bgColor = "#fff399";
        } else if (openDiff > 1.4) {
          recommendation = "M8 Butterfly";
          bgColor = "#b49aff";
        } else if (overnightDrop > 0.001 && overnightDrop < 0.65) {
          recommendation = "Straddle @ 9:32 AM";
          bgColor = "#61f7d6";
        } else {
          recommendation = "M8 Butterfly";
          bgColor = "#b49aff";
        }

        // ===== M8 block reasons (show ALL) =====
        const m8BlockReasons = [];
        if (fedToday && recommendation === "M8 Butterfly") m8BlockReasons.push("Fed day");
        if (postHoliday && recommendation === "M8 Butterfly") m8BlockReasons.push("Post-holiday");

        if (m8BlockReasons.length > 0) {
          recommendation = `No M8BF (${m8BlockReasons.join(", ")})`;
          bgColor = "#eee";
          crossedMain = true;
        }

        // NM override: convert M8 or No M8BF to NM Straddle (NOT on Monday)
        if (nmToday && !isMonday && (recommendation === "M8 Butterfly" || recommendation.startsWith("No M8BF"))) {
          recommendation = "NM Straddle @ 9:32 AM";
          bgColor = "#61f7d6";
          crossedMain = false;
        }

        // EOM override
        if (eomTradingDay) {
          recommendation = "Straddle @ 9:32 AM (EOM Straddle)";
          bgColor = "#61f7d6";
          crossedMain = false;
        }

        // Wednesday rule (NM overrides)
        if (isWednesday && !fedToday && !eomTradingDay && !nmToday && recommendation.startsWith("Straddle")) {
          recommendation = "M8 Butterfly";
          bgColor = "#b49aff";
        }

        // OPEX: no straddles (show ALL reasons if you add more later)
        const straddleBlockReasons = [];
        if (opexToday && recommendation.startsWith("Straddle")) straddleBlockReasons.push("OPEX day");

        if (straddleBlockReasons.length > 0) {
          recommendation = `No Straddle (${straddleBlockReasons.join(", ")})`;
          bgColor = "#eee";
          crossedMain = true;
        }

        // Post-OPEX Monday note (apply to any M8 Butterfly text)
        if (postOpexMonday && recommendation.startsWith("M8 Butterfly")) {
          addPostOpexNote = true;
        }

        /* ===== Win rate overrides =====
           - If 0% checked: automatic Straddle (still respects OPEX no-straddle)
           - If >90% checked: replace ONLY the base “Straddle @ 9:32 AM” with M8BF
        */
        if (winrateZero) {
          if (recommendation.startsWith("No Straddle")) {
            // keep blocked
          } else if (recommendation.startsWith("Straddle")) {
            recommendation = recommendation.includes("(EOM Straddle)")
              ? "Straddle @ 9:32 AM (EOM Straddle)"
              : "Straddle @ 9:32 AM (Win rate 0% prior day)";
            bgColor = "#61f7d6";
            crossedMain = false;
          } else {
            recommendation = "Straddle @ 9:32 AM (Win rate 0% prior day)";
            bgColor = "#61f7d6";
            crossedMain = false;
          }
        } else if (winrateHigh) {
          if (recommendation === "Straddle @ 9:32 AM") {
            recommendation = "M8 Butterfly (Win rate > 90% prior day)";
            bgColor = "#b49aff";
            crossedMain = false;
          }
        }
      }
     // ===== OPEX+1 override =====
// On the next trading day after OPEX, replace M8/Straddle with GXBF.
// BOBF stays unchanged.
if (postOpexDay) {
  const isM8 = recommendation.startsWith("M8 Butterfly");
  const isStraddle =
    recommendation.startsWith("Straddle") ||
    recommendation.startsWith("NM Straddle");

  if (isM8 || isStraddle) {
    recommendation = "GXBF @ 9:36 AM (OPEX+1)";
    bgColor = "#fff399";
    crossedMain = false;
    addPostOpexNote = false;
  }
}

      const recBlock = document.getElementById("recBlock");
      const mainRec = document.getElementById("mainRec");
      const bobfLine = document.getElementById("bobfLine");

      const mainText = addPostOpexNote
        ? `${recommendation} (use afternoon times for post OPEX Mondays)`
        : recommendation;

      mainRec.innerHTML = crossedMain ? `<span class="crossed">${mainText}</span>` : mainText;
      recBlock.style.backgroundColor = bgColor;

      // show the same "1st Monday" label under the calculator results
      const resultLbl = document.getElementById("resultDayLabel");
      if (resultLbl) resultLbl.textContent = tradingWeekdayOrdinalLabel(new Date());

      // =======================
      // BOBF rules (ALL reasons)
      // =======================
      let bobfReasons = [];

      if (nmMonday) bobfReasons.push("NM Monday");
      if (isFriday) bobfReasons.push("Friday");
      if (vixExpiryToday) bobfReasons.push("VIX expiration");
      if (opexMinus1) bobfReasons.push("OPEX-1");
      if (eomMinus2) bobfReasons.push("EOM-2");
      if (eomMinus1) bobfReasons.push("EOM-1");
      if (!isNaN(today) && today > 23) bobfReasons.push("high VIX");

      const bobfCrossed = bobfReasons.length > 0;
      const bobfText = bobfCrossed
        ? `No BOBF (${bobfReasons.join(", ")})`
        : "BOBF in play";

      bobfLine.innerHTML = bobfCrossed ? `<span class="crossed">${bobfText}</span>` : bobfText;
    }
  </script>

</body>
</html>






