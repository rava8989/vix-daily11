<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIX Strategy Helper</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: row;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      padding: 15px;
      border-right: 1px solid #ccc;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .sidebar h2 { font-size: 16px; margin-top: 0; }
    .sidebar .muted { font-size: 12px; color: #666; margin: 6px 0 10px 0; }
    .sidebar ul { padding-left: 18px; margin-top: 6px; margin-bottom: 18px; }

    .main { flex: 1; text-align: center; padding: 20px; }
    .calculator {
      background: #fff; padding: 15px; border-radius: 8px;
      box-shadow: 0 0 5px #ccc; max-width: 300px; margin: 0 auto 20px auto;
    }
    label { display: block; margin-top: 10px; }
    input { width: 100%; margin-top: 5px; margin-bottom: 10px; }
    input:disabled { opacity: 0.6; cursor: not-allowed; }
    button { width: 100%; padding: 8px; margin-top: 10px; }
    #recommendation {
      margin: 20px auto; font-size: 32px; font-weight: bold; color: #333;
      padding: 15px; max-width: 880px; border-radius: 8px; box-shadow: 0 0 5px #ccc;
    }
    .flowchart { margin: 20px auto; max-width: 100%; overflow-x: auto; }
    .tag {
      display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 11px;
      border: 1px solid #ccc; color: #555; margin-left: 6px; background: #fafafa;
    }

    /* Bottom strategy section */
    .strategy-doc {
      background: #fff;
      padding: 20px;
      margin: 20px auto 60px auto;
      max-width: 900px;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
      text-align: left;
      line-height: 1.5;
    }
    .strategy-doc h2 { font-size: 20px; margin: 0 0 10px 0; }
    .strategy-doc h3 { font-size: 16px; margin: 18px 0 8px 0; color: #333; }
    .strategy-doc .divider { margin: 16px 0; text-align: center; color: #999; letter-spacing: 2px; }
    .strategy-doc ul { margin: 6px 0 12px 22px; }
    .strategy-doc li { margin: 2px 0; }
    .muted-note { font-size: 12px; color: #666; margin-top: 6px; }
    .highlight {
      background: #f6f6ff;
      border-left: 3px solid #b49aff;
      padding: 10px 12px;
      border-radius: 6px;
    }

    /* Crossed-out past dates in schedules */
    .crossed { text-decoration: line-through; color: #999; }

    /* Secondary signals UI */
    .sub-signal {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
      box-shadow: 0 0 3px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>M8 Butterfly Trading Times</h2>
  <ul id="bfTimesList"></ul>

  <h2>Straddle Trading Time</h2>
  <p>9:32 AM</p>
  <p class="muted">Last update: 10/20/2025</p>

  <!-- CPI Schedule -->
  <h2>CPI Schedule</h2>
  <ul id="cpiSchedule"></ul>

  <!-- Fed Day Schedule -->
  <h2>Fed Day Schedule</h2>
  <ul id="fedSchedule"></ul>

  <!-- Quarterly OPEX -->
  <h2>Quarterly OPEX</h2>
  <ul id="opexSchedule"></ul>

  <!-- Monthly OPEX -->
  <h2>Monthly OPEX</h2>
  <ul id="monthlyOpexSchedule"></ul>

  <!-- Market Holidays -->
  <h2>Market Holidays</h2>
  <ul id="holidaySchedule"></ul>

  <!-- VIX Expiration -->
  <h2>VIX Expiration</h2>
  <ul id="vixExpirySchedule"></ul>
</div>

<div class="main">

  <div class="calculator">
    <h1>VIX Calculator</h1>
    <label>VIX Today’s Open:
      <input type="number" id="todayOpen" step="0.01" />
    </label>
    <label>VIX Yesterday’s Open:
      <input type="number" id="yesterdayOpen" step="0.01" />
    </label>
    <label>VIX Yesterday’s Close:
      <input type="number" id="yesterdayClose" step="0.01" />
    </label>
    <button onclick="calculateStrategy()">Calculate</button>
  </div>

  <div style="margin-top: 10px; font-size: 14px; text-align: center;">
    <p>
      <strong>Overnight VIX Drop:</strong>
      <span id="overnightDropDisplay">—</span>
      <span id="cpiTag" class="tag" style="display:none;">CPI day</span>
      <span id="fedTag" class="tag" style="display:none;">Fed day</span>
      <span id="opexTag" class="tag" style="display:none;">Quarterly OPEX</span>
      <span id="postOpexTag" class="tag" style="display:none;">Post-OPEX</span>
      <span id="postHolidayTag" class="tag" style="display:none;">Post-Holiday</span>
      <span id="eomTag" class="tag" style="display:none;">EOM</span>
    </p>
    <p>
      <strong>Yesterday’s VIX Open − Today’s VIX Open:</strong>
      <span id="openDiffDisplay">—</span>
      <span id="openDiffNote" class="tag" style="display:none;">ignored on CPI day</span>
    </p>
  </div>

  <div style="text-align: right;">
    <div id="todayDate" style="font-size: 14px; color: #666; margin-bottom: 5px;"></div>
  </div>
  <div id="recommendation"></div>

  <!-- Secondary signals -->
  <div id="secondarySignals" style="max-width:880px;margin:10px auto 0 auto;text-align:left;">
    <div id="bobfSignal" class="sub-signal"></div>
    <div id="atm1pmSignal" class="sub-signal" style="margin-top:6px;"></div>
  </div>

  <div class="flowchart">
    <div class="mermaid">
flowchart TD
    A[SPX overnight gap UP/DOWN &lt; 0.9%?]
    A -->|No| B1[M8 Butterfly]
    A -->|Yes| C[Yesterday's VIX open - Today's VIX open &lt; 1.4?]
    C -->|No| B2[M8 Butterfly]
    C -->|Yes| D[Overnight VIX drop &gt; 0.65?]
    D -->|Yes| E[BvS Butterfly @ 9:36 AM]
    D -->|No| F[Overnight VIX drop 0.01–0.65?]
    F -->|Yes| G[Straddle @ 9:32 AM]
    F -->|No| B3[M8 Butterfly]

    class B1,B2,B3 butterfly
    class E atm
    class G straddle

    classDef butterfly fill:#b49aff,stroke:#333,stroke-width:1px
    classDef straddle fill:#61f7d6,stroke:#333,stroke-width:1px
    classDef atm fill:#fff399,stroke:#333,stroke-width:1px
    </div>
  </div>

  <!-- Bottom strategy documentation -->
  <section class="strategy-doc" id="strategy-doc">
    <h2>Hybrid SPX 0DTE Strategy — Overview</h2>
    <p>This is the hybrid SPX 0DTE strategy. It classifies days into three distinct types:</p>

    <div class="highlight">
      <h3>Teal Days — Straddle</h3>
      <ul>
        <li>Traded between <strong>9:32 AM</strong> and <strong>1:30 PM</strong>.</li>
      </ul>

      <h3>Purple Days — M8 Butterfly</h3>
      <ul>
        <li>Based on M8’s recommendation, with entry times varying by day of the week.</li>
        <li>This setup is less effective without TTV software, which helps identify optimal entry windows for butterflies.</li>
        <li>I’ll try my best to update the best entry times weekly on my webpage.</li>
      </ul>

      <h3>Yellow Days — BvS Butterfly</h3>
      <ul>
        <li>Traded at <strong>9:36 AM</strong>, centered around a major positive gamma value taken from <strong>9:35 AM gex-bot-stream</strong> feed.</li>
      </ul>
    </div>

    <div class="divider">⸻</div>

    <h3>Rules for Day Classification</h3>
    <p>Here’s the logic:</p>
    <ul>
      <li><strong>Check SPX overnight gap at the open:</strong><br/>
        • If the gap (up or down) is <strong>&gt; 0.9%</strong>, it’s a <strong>Purple Day (M8 Butterfly)</strong>.<br/>
        • If the gap is <strong>&lt; 0.9%</strong>, continue:
      </li>

      <li><strong>Open-to-open VIX:</strong> Yesterday’s VIX open − today’s VIX open.<br/>
        • If this value is <strong>&gt; 1.4</strong>, it’s a <strong>Purple Day</strong>.<br/>
        • Otherwise, continue:
      </li>

      <li><strong>Overnight VIX drop:</strong> (Yesterday’s VIX close @ 4:15 PM − today’s VIX open @ 9:30 AM)<br/>
        • If <strong>&gt; 0.65</strong> → <strong>Yellow Day (BvS Butterfly @ 9:36 AM)</strong>.<br/>
        • If <strong>0.01–0.65</strong> → <strong>Teal Day (Straddle @ 9:32 AM)</strong>.<br/>
        • If none of the above → <strong>Purple Day</strong>.
      </li>
    </ul>

    <ul>
      <li><strong>CPI days:</strong> Use <em>only</em> one filter → <strong>Yesterday’s Close − Today’s Open</strong>.<br/>
        • If negative → <strong>No Trade</strong>.<br/>
        • If zero/positive → <strong>Straddle @ 9:32 AM</strong>.
      </li>

      <li><strong>Fed days:</strong> <strong>No M8 Butterfly,</strong> <strong>Straddle and</strong> <em>BvS Butterfly is allowed.</em></li>

      <li><strong>Wednesdays (non-Fed, non-CPI):</strong> <strong>NO Straddle</strong> take <strong>M8 Butterfly</strong> instead.</li>

      <li><strong>Quarterly OPEX:</strong> <strong>No Straddle</strong>. <em>Post-OPEX Monday:</em> if Purple Day signal, use <strong>afternoon M8</strong>. <em>After other OPEX:</em> if Purple Day signal, use <strong>morning M8</strong>.</li>

      <li><strong>Day After Market Holiday:</strong> <strong>No M8 Butterflies</strong>.</li>

      <li><strong>End-of-Month (EOM):</strong> <strong>Automatic Straddle @ 9:32 AM</strong> (“EOM Straddle”).</li>

      <li><strong>0% Win-Rate Rule:</strong> If the M8 SPX Butterfly prediction has a <strong>0% win rate</strong> for the entire day, then the <strong>next day</strong> we automatically take a <strong>9:32 AM Straddle</strong> trade, using the same rules as the overnight VIX-down (Teal day) straddle.</li>
    </ul>

    <h3>Additional Trade Signals</h3>
    <ul>
      <li><strong>BOBF signal:</strong> “No BOBF” on <em>Mondays</em>, on <em>VIX monthly expiration</em> days, and on the <em>last trading day of the month</em>. Otherwise, “BOBF in play”.</li>
      <li><strong>1PM ATM BF signal:</strong> “1PM ATM BF in play” only if <em>Overnight VIX is up</em> (yesterday close − today open &lt; 0). Block it on <em>Mondays</em>, on <em>VIX monthly expiration</em> days, and on the <em>last trading day of the month</em>.</li>
    </ul>

    <h3>Money Management</h3>
    <ul>
      <li><strong>Butterflies (Purple & Yellow):</strong> Max risk <strong>$1,400</strong>. Widen wings to target this; acceptable to settle near <strong>$1,000</strong> if the next strike exceeds $1,400.</li>
      <li><strong>Straddles (Teal):</strong> Max risk <strong>$3,200</strong> (same as Mad’s). On <strong>Thursdays</strong>, use <strong>$2,700 take-profit</strong>.</li>
      <li>All trades are held to <strong>expiration</strong>.</li>
    </ul>

    <h3>Backtest Results (September 1, 2024 → September 1, 2025)</h3>
    <ul>
      <li><strong>Teal Days (Straddle):</strong> +$63K</li>
      <li><strong>Purple Days (M8 Butterfly):</strong> +$84K</li>
      <li><strong>Yellow Days (BvS Butterfly):</strong> +$19K</li>
      <li><strong>Total P/L:</strong> ~<strong>$166K</strong> in a year.</li>
      <li><em>Only one trade is allowed per day. Some days may have no trade if conditions aren’t met.</em></li>
    </ul>

    <div class="divider">⸻</div>

    <p>I know the rules can seem complicated at first, which is why I created a calculator page. Simply input the VIX data, and it will indicate the type of day it is.</p>

    <p class="muted-note"><strong>Disclaimer:</strong> This content is for informational and educational purposes only and does not constitute financial, investment, or trading advice. Past performance is not indicative of future results. Trading options involves significant risk and may not be suitable for all investors. You are solely responsible for your own investment decisions.</p>
  </section>

</div>

<script>
const bfTimes = {
  1: { day: "Monday", time: "9:35 AM" },
  2: { day: "Tuesday", time: "10:50 AM" },
  3: { day: "Wednesday", time: "13:35 PM" }, // keep as you last set it
  4: { day: "Thursday", time: "10:35 AM" },
  5: { day: "Friday", time: "10:55 AM" }
};
const M8_AFTERNOON_TIME = "1:35 PM"; // generic afternoon time hint

function renderBFList() {
  const ul = document.getElementById('bfTimesList');
  for (let i = 1; i <= 5; i++) {
    const li = document.createElement('li');
    li.textContent = `${bfTimes[i].day} — ${bfTimes[i].time}`;
    ul.appendChild(li);
  }
}
renderBFList();

// CPI dates (remaining 2025) — using your latest list
const cpiSchedule = [
  "September 11, 2025",
  "October 24, 2025",
  "November 13, 2025",
  "December 10, 2025"
];
function renderCPISchedule() {
  const ul = document.getElementById('cpiSchedule');
  cpiSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderCPISchedule();

// Fed Day dates (remaining 2025)
const fedSchedule = [
  "September 17, 2025",
  "October 29, 2025",
  "December 10, 2025"
];
function renderFedSchedule() {
  const ul = document.getElementById('fedSchedule');
  fedSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderFedSchedule();

// Quarterly OPEX (SPX) — 2025 quarterlies
const opexSchedule = [
  "March 21, 2025",
  "June 20, 2025",
  "September 19, 2025",
  "December 19, 2025"
];
function renderOpexSchedule() {
  const ul = document.getElementById('opexSchedule');
  opexSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderOpexSchedule();

// Monthly OPEX (non-quarterly) — 2025 typical expirations excluding Mar/Jun/Sep/Dec
const monthlyOpexSchedule = [
  "January 17, 2025",
  "February 21, 2025",
  "April 17, 2025",   // Thursday (Good Friday on 18th)
  "May 16, 2025",
  "July 18, 2025",
  "August 15, 2025",
  "October 17, 2025",
  "November 21, 2025"
];
function renderMonthlyOpex() {
  const ul = document.getElementById('monthlyOpexSchedule');
  monthlyOpexSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderMonthlyOpex();

// US Market Holidays — 2025 (observed full-day closures)
const marketHolidays = [
  "January 1, 2025",   // New Year's Day
  "January 20, 2025",  // MLK Day
  "February 17, 2025", // Presidents' Day
  "April 18, 2025",    // Good Friday
  "May 26, 2025",      // Memorial Day
  "June 19, 2025",     // Juneteenth
  "July 4, 2025",      // Independence Day
  "September 1, 2025", // Labor Day
  "November 27, 2025", // Thanksgiving Day
  "December 25, 2025"  // Christmas Day
];
function renderHolidaySchedule() {
  const ul = document.getElementById('holidaySchedule');
  marketHolidays.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderHolidaySchedule();

// VIX monthly option expirations — remaining 2025
const vixExpirySchedule = [
  "October 22, 2025",
  "November 19, 2025",
  "December 17, 2025"
];
function renderVixExpiry() {
  const ul = document.getElementById('vixExpirySchedule');
  vixExpirySchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderVixExpiry();

// Cross-out helpers (keeps past dates visible but struck-through)
function hasPassed(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  const endOfDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);
  return new Date() > endOfDay;
}
function crossOffPastDates(ulId) {
  const ul = document.getElementById(ulId);
  if (!ul) return;
  Array.from(ul.children).forEach(li => {
    const dateText = li.getAttribute('data-date') || li.textContent.trim();
    if (hasPassed(dateText)) li.classList.add('crossed');
  });
}
function refreshCrossedDates() {
  crossOffPastDates('cpiSchedule');
  crossOffPastDates('fedSchedule');
  crossOffPastDates('opexSchedule');
  crossOffPastDates('monthlyOpexSchedule');
  crossOffPastDates('holidaySchedule');
  crossOffPastDates('vixExpirySchedule');
}
document.addEventListener('DOMContentLoaded', () => {
  refreshCrossedDates();
  const now = new Date();
  const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 2);
  setTimeout(() => {
    refreshCrossedDates();
    setInterval(refreshCrossedDates, 24 * 60 * 60 * 1000);
  }, midnight - now);
});

function todayLongUS() {
  return new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}
function isCpiDay() {
  return cpiSchedule.includes(todayLongUS());
}
function isFedDay() {
  return fedSchedule.includes(todayLongUS());
}
function isOpexDay() {
  return opexSchedule.includes(todayLongUS());
}
function isMonthlyOpexDay() {
  return monthlyOpexSchedule.includes(todayLongUS());
}
function isVixExpiryDay() {
  return vixExpirySchedule.includes(todayLongUS());
}

// Trading-day helpers
function isWeekend(d) {
  const day = d.getDay();
  return day === 0 || day === 6;
}
function isHoliday(d) {
  const asLong = d.toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
  return marketHolidays.includes(asLong);
}
function nextTradingDay(d) {
  const nd = new Date(d);
  do {
    nd.setDate(nd.getDate() + 1);
  } while (isWeekend(nd) || isHoliday(nd));
  return nd;
}
function prevTradingDay(d) {
  const pd = new Date(d);
  do {
    pd.setDate(pd.getDate() - 1);
  } while (isWeekend(pd) || isHoliday(pd));
  return pd;
}
function isTodayFirstTradingDayAfter(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  const after = nextTradingDay(d);
  const today = new Date();
  return (
    after.getFullYear() === today.getFullYear() &&
    after.getMonth() === today.getMonth() &&
    after.getDate() === today.getDate()
  );
}
function isPostQuarterlyOpexMonday() {
  const postAny = opexSchedule.some(isTodayFirstTradingDayAfter);
  return postAny && new Date().getDay() === 1;
}
function isPostMonthlyOpex() {
  return monthlyOpexSchedule.some(isTodayFirstTradingDayAfter);
}
function isPostHoliday() {
  return marketHolidays.some(isTodayFirstTradingDayAfter);
}

// EOM detection (last TRADING day of month)
function isLastTradingDayOfMonth(date = new Date()) {
  const next = nextTradingDay(date);
  return next.getMonth() !== date.getMonth();
}

// On load, reflect CPI-day UI
function updateCpiUI() {
  const cpi = isCpiDay();
  document.getElementById('yesterdayOpen').disabled = cpi; // disable Yesterday's Open on CPI days only
}
document.addEventListener('DOMContentLoaded', updateCpiUI);

document.getElementById('todayDate').textContent =
  "Today’s Date: " + new Date().toLocaleDateString();

function calculateStrategy() {
  const today = parseFloat(document.getElementById('todayOpen').value);
  const yOpen = parseFloat(document.getElementById('yesterdayOpen').value);
  const yClose = parseFloat(document.getElementById('yesterdayClose').value);

  if (isNaN(today) || isNaN(yClose) || (!isCpiDay() && isNaN(yOpen))) {
    alert("Please enter valid numbers.");
    return;
  }

  const cpiToday = isCpiDay();
  const fedToday = isFedDay();
  const opexToday = isOpexDay();
  const monthlyOpexToday = isMonthlyOpexDay();
  const postQuarterlyOpexMonday = isPostQuarterlyOpexMonday();
  const postMonthlyOpex = isPostMonthlyOpex();
  const postHoliday = isPostHoliday();
  const eomTradingDay = isLastTradingDayOfMonth(new Date());
  const isMonday = new Date().getDay() === 1;
  const vixExpiryToday = isVixExpiryDay();

  // show context tags
  document.getElementById('cpiTag').style.display = cpiToday ? 'inline-block' : 'none';
  document.getElementById('fedTag').style.display = fedToday ? 'inline-block' : 'none';
  document.getElementById('opexTag').style.display = opexToday ? 'inline-block' : 'none';
  document.getElementById('postOpexTag').style.display =
    (postQuarterlyOpexMonday || postMonthlyOpex) ? 'inline-block' : 'none';
  document.getElementById('postHolidayTag').style.display = postHoliday ? 'inline-block' : 'none';
  document.getElementById('eomTag').style.display = eomTradingDay ? 'inline-block' : 'none';

  const dayOfWeek = new Date().getDay(); // 0=Sun,1=Mon,...,3=Wed
  let m8Time = bfTimes[dayOfWeek]?.time || "";

  const openDiff = (isNaN(yOpen) ? NaN : yOpen - today); // ignored on CPI day
  const overnightDrop = yClose - today; // used on CPI + non-CPI

  // UI numbers
  document.getElementById('overnightDropDisplay').textContent = isNaN(overnightDrop) ? '—' : overnightDrop.toFixed(2);
  const openDiffDisplay = document.getElementById('openDiffDisplay');
  const openDiffNote = document.getElementById('openDiffNote');
  if (cpiToday) {
    openDiffDisplay.textContent = '—';
    openDiffNote.style.display = 'inline-block';
  } else {
    openDiffNote.style.display = 'none';
    openDiffDisplay.textContent = isNaN(openDiff) ? '—' : openDiff.toFixed(2);
  }

  let recommendation = "";
  let bgColor = "#eee";

  if (cpiToday) {
    // CPI: use Yesterday’s Close − Today’s Open only
    if (overnightDrop < 0) {
      recommendation = "No Trade (CPI day)";
      bgColor = "#eee";
    } else {
      recommendation = "Straddle @ 9:32 AM (CPI day)";
      bgColor = "#61f7d6";
    }
  } else {
    // BASE non-CPI logic
    if (overnightDrop > 0.65 && openDiff < 1.4) {
      recommendation = "BvS Butterfly @ 9:36 AM";
      bgColor = "#fff399";
    } else if (overnightDrop >= 0.01 && overnightDrop < 0.65 && openDiff < 1.4) {
      recommendation = "Straddle @ 9:32 AM";
      bgColor = "#61f7d6";
    } else {
      recommendation = `M8 Butterfly — ${m8Time}`;
      bgColor = "#b49aff";
    }

    // Fed-day override: block ONLY M8 Butterfly; allow Straddle and BvS
    if (fedToday && /M8 Butterfly/.test(recommendation)) {
      recommendation = "No Trade (Fed day — no M8 butterflies)";
      bgColor = "#eee";
    }

    // Day after market holiday: no M8 butterflies
    if (postHoliday && /M8 Butterfly/.test(recommendation)) {
      recommendation = "No Trade (day after market holiday — no M8 butterflies)";
      bgColor = "#eee";
    }

    // EOM override: last trading day of month forces Straddle @ 9:32 (EOM Straddle)
    if (eomTradingDay) {
      recommendation = "Straddle @ 9:32 AM (EOM Straddle)";
      bgColor = "#61f7d6";
    }

    // Wednesday rule: Wed + NOT Fed + NOT CPI + Straddle -> M8 (but do NOT convert on EOM)
    const isWednesday = dayOfWeek === 3;
    if (isWednesday && !fedToday && !cpiToday && !eomTradingDay && /Straddle/.test(recommendation)) {
      recommendation = `M8 Butterfly — ${m8Time}`;
      bgColor = "#b49aff";
    }

    // Post-OPEX timing hints for M8
    if (/M8 Butterfly/.test(recommendation)) {
      if (postQuarterlyOpexMonday) {
        recommendation = `M8 Butterfly — ${M8_AFTERNOON_TIME} (post-Quarterly OPEX Monday: use afternoon M8)`;
      } else if (postMonthlyOpex) {
        recommendation = `M8 Butterfly — ${m8Time} (post-OPEX: use morning M8)`;
      }
    }
  }

  // Quarterly OPEX override: if Straddle is recommended, say No Trade
  if (opexToday && /Straddle/.test(recommendation)) {
    recommendation = "No Trade (Quarterly OPEX — no Straddles)";
    bgColor = "#eee";
  }

  const recBox = document.getElementById("recommendation");
  recBox.innerHTML = `👉 <span style="font-size: 28px;">${recommendation}</span>`;
  recBox.style.backgroundColor = bgColor;

  // ---------- Secondary signals ----------
  const bobfEl = document.getElementById("bobfSignal");
  const atm1pmEl = document.getElementById("atm1pmSignal");

  // BOBF rules: No BOBF on Mondays, on VIX expiration days, or on EOM trading day
  let bobfText = "BOBF in play";
  if (isMonday) {
    bobfText = "No BOBF (Monday)";
  } else if (vixExpiryToday) {
    bobfText = "No BOBF (VIX expiration)";
  } else if (eomTradingDay) {
    bobfText = "No BOBF (EOM)";
  }
  bobfEl.textContent = `BOBF: ${bobfText}`;

  // 1PM ATM BF rules: only when Overnight VIX is up (overnightDrop < 0)
  // Block on Mondays, VIX expiration, EOM
  let atmText = "1PM ATM BF in play";
  if (!(overnightDrop < 0)) {
    atmText = "No 1PM ATM BF (needs overnight VIX up)";
  } else if (isMonday) {
    atmText = "No 1PM ATM BF (Monday)";
  } else if (vixExpiryToday) {
    atmText = "No 1PM ATM BF (VIX expiration)";
  } else if (eomTradingDay) {
    atmText = "No 1PM ATM BF (EOM)";
  }
  atm1pmEl.textContent = atmText;
}
</script>

</body>
</html>
