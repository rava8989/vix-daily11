<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VIX Strategy Helper</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: row;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      padding: 15px;
      border-right: 1px solid #ccc;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .sidebar h2 { font-size: 16px; margin-top: 0; }
    .sidebar .muted { font-size: 12px; color: #666; margin: 6px 0 10px 0; }
    .sidebar ul { padding-left: 18px; margin-top: 6px; margin-bottom: 18px; }

    .main { flex: 1; text-align: center; padding: 20px; }
    .calculator {
      background: #fff; padding: 15px; border-radius: 8px;
      box-shadow: 0 0 5px #ccc; max-width: 300px; margin: 0 auto 20px auto;
    }
    label { display: block; margin-top: 10px; }
    input { width: 100%; margin-top: 5px; margin-bottom: 10px; }
    input:disabled { opacity: 0.6; cursor: not-allowed; }
    button { width: 100%; padding: 8px; margin-top: 10px; }

    /* Unified recommendation block (ALL LINES SAME SIZE) */
    #recBlock {
      margin: 20px auto;
      padding: 15px;
      max-width: 880px;
      border-radius: 8px;
      box-shadow: 0 0 5px #ccc;
      color: #333;
      text-align: left;
      line-height: 1.35;
      font-size: 28px; /* same size for all 3 lines */
    }
    #recBlock .row { margin: 6px 0; }
    #recBlock .mainline { font-weight: bold; } /* only bold, same size */

    .flowchart { margin: 20px auto; max-width: 100%; overflow-x: auto; }
    .tag {
      display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 11px;
      border: 1px solid #ccc; color: #555; margin-left: 6px; background: #fafafa;
    }

    /* Bottom strategy section */
    .strategy-doc {
      background: #fff;
      padding: 20px;
      margin: 20px auto 60px auto;
      max-width: 900px;
      border-radius: 10px;
      box-shadow: 0 0 5px #ccc;
      text-align: left;
      line-height: 1.5;
    }
    .strategy-doc h2 { font-size: 20px; margin: 0 0 10px 0; }
    .strategy-doc h3 { font-size: 16px; margin: 18px 0 8px 0; color: #333; }
    .strategy-doc .divider { margin: 16px 0; text-align: center; color: #999; letter-spacing: 2px; }
    .strategy-doc ul { margin: 6px 0 12px 22px; }
    .strategy-doc li { margin: 2px 0; }
    .muted-note { font-size: 12px; color: #666; margin-top: 6px; }
    .highlight {
      background: #f6f6ff;
      border-left: 3px solid #b49aff;
      padding: 10px 12px;
      border-radius: 6px;
    }

    /* Crossed-out past dates in schedules */
    .crossed { text-decoration: line-through; color: #999; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Straddle Trading Time</h2>
  <p>9:32 AM</p>
  <p class="muted">Last update: 10/20/2025</p>

  <!-- CPI Schedule -->
  <h2>CPI Schedule</h2>
  <ul id="cpiSchedule"></ul>

  <!-- Fed Day Schedule -->
  <h2>Fed Day Schedule</h2>
  <ul id="fedSchedule"></ul>

  <!-- Quarterly OPEX -->
  <h2>Quarterly OPEX</h2>
  <ul id="opexSchedule"></ul>

  <!-- Monthly OPEX -->
  <h2>Monthly OPEX</h2>
  <ul id="monthlyOpexSchedule"></ul>

  <!-- Market Holidays -->
  <h2>Market Holidays</h2>
  <ul id="holidaySchedule"></ul>

  <!-- VIX Expiration -->
  <h2>VIX Expiration</h2>
  <ul id="vixExpirySchedule"></ul>
</div>

<div class="main">

  <div class="calculator">
    <h1>VIX Calculator</h1>
    <label>VIX Today‚Äôs Open:
      <input type="number" id="todayOpen" step="0.01" />
    </label>
    <label>VIX Yesterday‚Äôs Open:
      <input type="number" id="yesterdayOpen" step="0.01" />
    </label>
    <label>VIX Yesterday‚Äôs Close:
      <input type="number" id="yesterdayClose" step="0.01" />
    </label>
    <button onclick="calculateStrategy()">Calculate</button>
  </div>

  <div style="margin-top: 10px; font-size: 14px; text-align: center;">
    <p>
      <strong>Overnight VIX Drop:</strong>
      <span id="overnightDropDisplay">‚Äî</span>
      <span id="cpiTag" class="tag" style="display:none;">CPI day</span>
      <span id="fedTag" class="tag" style="display:none;">Fed day</span>
      <span id="opexTag" class="tag" style="display:none;">Quarterly OPEX</span>
      <span id="postOpexTag" class="tag" style="display:none;">Post-OPEX</span>
      <span id="postHolidayTag" class="tag" style="display:none;">Post-Holiday</span>
      <span id="eomTag" class="tag" style="display:none;">EOM</span>
    </p>
    <p>
      <strong>Yesterday‚Äôs VIX Open ‚àí Today‚Äôs VIX Open:</strong>
      <span id="openDiffDisplay">‚Äî</span>
      <span id="openDiffNote" class="tag" style="display:none;">ignored on CPI day</span>
    </p>
  </div>

  <div style="text-align: right;">
    <div id="todayDate" style="font-size: 14px; color: #666; margin-bottom: 5px;"></div>
  </div>

  <!-- Unified recommendation + sub-signals block -->
  <div id="recBlock">
    <div class="row mainline" id="mainRec">üëâ ‚Äî</div>
    <div class="row" id="bf1pmLine">‚Äî</div>
    <div class="row" id="bobfLine">‚Äî</div>
  </div>

  <div class="flowchart">
    <div class="mermaid">
flowchart TD
  A[SPX gap less than 0.9] -->|No| M1[M8 Butterfly]
  A -->|Yes| D[Overnight VIX drop greater than 0.65]
  D -->|Yes| X[GXBF at 9:36]
  D -->|No| O[Open to open VIX greater than 1.4]
  O -->|Yes| M2[M8 Butterfly]
  O -->|No| S[Overnight VIX drop between 0.01 and 0.65]
  S -->|Yes| T[Straddle at 9:32]
  S -->|No| M3[M8 Butterfly]

  class M1,M2,M3 butterfly
  class X atm
  class T straddle

  classDef butterfly fill:#b49aff,stroke:#333,stroke-width:1px
  classDef straddle fill:#61f7d6,stroke:#333,stroke-width:1px
  classDef atm fill:#fff399,stroke:#333,stroke-width:1px
    </div>
  </div>

  <!-- Bottom strategy documentation -->
  <section class="strategy-doc" id="strategy-doc">
    <h2>Hybrid SPX 0DTE Strategy ‚Äî Overview</h2>
    <p>This is the hybrid SPX 0DTE strategy. It classifies days into three distinct types:</p>

    <div class="highlight">
      <h3>Teal Days ‚Äî Straddle</h3>
      <ul>
        <li>Traded between <strong>9:32 AM</strong> and <strong>1:30 PM</strong>.</li>
      </ul>

      <h3>Purple Days ‚Äî M8 Butterfly</h3>
      <ul>
        <li>Based on M8‚Äôs recommendation.</li>
        <li>This setup is less effective without TTV software, which helps identify optimal entry windows for butterflies.</li>
        <li>I‚Äôll try my best to update the best entry times weekly on my webpage.</li>
      </ul>

      <h3>Yellow Days ‚Äî Gex Butterfly (GXBF)</h3>
      <ul>
        <li>Traded at <strong>9:36 AM</strong>, centered around a major positive gamma value taken from <strong>9:35 AM gex-bot-stream</strong> feed.</li>
      </ul>
    </div>

    <div class="divider">‚∏ª</div>

    <h3>Rules for Day Classification</h3>
    <p>Here‚Äôs the logic:</p>
    <ul>
      <li><strong>Check SPX overnight gap at the open:</strong><br/>
        ‚Ä¢ If the gap (up or down) is <strong>&gt; 0.9%</strong>, it‚Äôs a <strong>Purple Day (M8 Butterfly)</strong>.<br/>
        ‚Ä¢ If the gap is <strong>&lt; 0.9%</strong>, continue:
      </li>

      <li><strong>Overnight VIX drop:</strong> (Yesterday‚Äôs VIX close @ 4:15 PM ‚àí today‚Äôs VIX open @ 9:30 AM)<br/>
        ‚Ä¢ If <strong>&gt; 0.65</strong> ‚Üí <strong>Yellow Day (GXBF @ 9:36 AM)</strong>.<br/>
        ‚Ä¢ If <strong>0.01‚Äì0.65</strong> ‚Üí <strong>Teal Day (Straddle @ 9:32 AM)</strong>.<br/>
        ‚Ä¢ If none of the above ‚Üí <strong>Purple Day</strong>.
      </li>

      <li><strong>Open-to-open VIX:</strong> Yesterday‚Äôs VIX open ‚àí today‚Äôs VIX open.<br/>
        ‚Ä¢ If this value is <strong>&gt; 1.4</strong>, it‚Äôs a <strong>Purple Day</strong>.<br/>
        ‚Ä¢ Otherwise, continue:
      </li>
    </ul>

    <ul>
      <li><strong>CPI days:</strong> Use <em>only</em> one filter ‚Üí <strong>Yesterday‚Äôs Close ‚àí Today‚Äôs Open</strong>.<br/>
        ‚Ä¢ If negative ‚Üí <strong>No Trade</strong>.<br/>
        ‚Ä¢ If zero/positive ‚Üí <strong>Straddle @ 9:32 AM</strong>.
      </li>

      <li><strong>Fed days:</strong> <strong>No M8 Butterfly</strong>. <em>Straddle and GXBF are allowed.</em></li>

      <li><strong>Wednesdays (non-Fed, non-CPI):</strong> <strong>No Straddle</strong> (take <strong>M8 Butterfly</strong> instead).</li>

      <li><strong>Quarterly OPEX:</strong> <strong>No Straddle</strong>. <em>Post-OPEX Monday:</em> if Purple Day signal, use <strong>afternoon M8</strong>. <em>After other OPEX:</em> if Purple Day signal, use <strong>morning M8</strong>.</li>

      <li><strong>Day After Market Holiday:</strong> <strong>No M8 Butterflies</strong>.</li>

      <li><strong>End-of-Month (EOM):</strong> <strong>Automatic Straddle @ 9:32 AM</strong> (‚ÄúEOM Straddle‚Äù).</li>

      <li><strong>0% Win-Rate Rule:</strong> If the M8 SPX Butterfly prediction has a <strong>0% win rate</strong> for the entire day, then the <strong>next day</strong> we automatically take a <strong>9:32 AM Straddle</strong> trade, using the same rules as the overnight VIX-down (Teal day) straddle.</li>
    </ul>

    <h3>Additional Trade Signals</h3>
<ul>
  <li><strong>BOBF rules:</strong>
    Skip <em>Fridays</em>, <em>monthly VIX expiration</em> days, <em>OPEX-1</em>,
    and <em>EOM-2 / EOM-1</em>. Max <em>VIX 23</em>.
  </li>
  <li><strong>1PM BF rules:</strong>
    Skip <em>Mondays</em>, trade only on <em>overnight VIX up</em> days,
    skip <em>monthly VIX expiration</em> days, skip <em>EOM and EOM-1</em>,
    skip if <em>VIX open &lt; 16</em>. Max risk <em>$1,400</em>.
  </li>
</ul>

    <h3>Money Management</h3>
    <ul>
      <li><strong>Butterflies (Purple & Yellow):</strong> Max risk <strong>$1,400</strong>. Widen wings to target this; acceptable to settle near <strong>$1,000</strong> if the next strike exceeds $1,400.</li>
      <li><strong>Straddles (Teal):</strong> Max risk <strong>$3,200</strong> (same as Mad‚Äôs). On <strong>Thursdays</strong>, use <strong>$2,700 take-profit</strong>.</li>
      <li>All trades are held to <strong>expiration</strong>.</li>
    </ul>

   
    <ul>
      <li><em>Only one trade is allowed per day. Some days may have no trade if conditions aren‚Äôt met.</em></li>
    </ul>

    <div class="divider">‚∏ª</div>

    <p>I know the rules can seem complicated at first, which is why I created a calculator page. Simply input the VIX data, and it will indicate the type of day it is.</p>

    <p class="muted-note"><strong>Disclaimer:</strong> This content is for informational and educational purposes only and does not constitute financial, investment, or trading advice. Past performance is not indicative of future results. Trading options involves significant risk and may not be suitable for all investors. You are solely responsible for your own investment decisions.</p>
  </section>

</div>

<script>
// CPI dates (remaining 2025)
const cpiSchedule = [
  "September 11, 2025",
  "October 24, 2025",
  "November 13, 2025",
  "December 18, 2025"
];
function renderCPISchedule() {
  const ul = document.getElementById('cpiSchedule');
  cpiSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderCPISchedule();

// Fed Day dates (remaining 2025)
const fedSchedule = [
  "September 17, 2025",
  "October 29, 2025",
  "December 10, 2025"
];
function renderFedSchedule() {
  const ul = document.getElementById('fedSchedule');
  fedSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderFedSchedule();

// Quarterly OPEX (SPX) ‚Äî 2025 quarterlies
const opexSchedule = [
  "March 21, 2025",
  "June 20, 2025",
  "September 19, 2025",
  "December 19, 2025"
];
function renderOpexSchedule() {
  const ul = document.getElementById('opexSchedule');
  opexSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderOpexSchedule();

// Monthly OPEX (non-quarterly) ‚Äî 2025 typical expirations excluding Mar/Jun/Sep/Dec
const monthlyOpexSchedule = [
  "January 17, 2025",
  "February 21, 2025",
  "April 17, 2025",   // Thursday (Good Friday on 18th)
  "May 16, 2025",
  "July 18, 2025",
  "August 15, 2025",
  "October 17, 2025",
  "November 21, 2025"
];
function renderMonthlyOpex() {
  const ul = document.getElementById('monthlyOpexSchedule');
  monthlyOpexSchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderMonthlyOpex();

// US Market Holidays ‚Äî 2025 (observed full-day closures)
const marketHolidays = [
  "January 1, 2025",
  "January 20, 2025",
  "February 17, 2025",
  "April 18, 2025",
  "May 26, 2025",
  "June 19, 2025",
  "July 4, 2025",
  "September 1, 2025",
  "November 27, 2025",
  "December 25, 2025"
];
function renderHolidaySchedule() {
  const ul = document.getElementById('holidaySchedule');
  marketHolidays.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderHolidaySchedule();

// VIX monthly option expirations ‚Äî remaining 2025
const vixExpirySchedule = [
  "October 22, 2025",
  "November 19, 2025",
  "December 17, 2025"
];
function renderVixExpiry() {
  const ul = document.getElementById('vixExpirySchedule');
  vixExpirySchedule.forEach(date => {
    const li = document.createElement('li');
    li.textContent = date;
    li.setAttribute('data-date', date);
    ul.appendChild(li);
  });
}
renderVixExpiry();

/* ----------------- Cross-off passed dates ----------------- */
function hasPassed(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  const endOfDay = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);
  return new Date() > endOfDay;
}
function crossOffPastDates(ulId) {
  const ul = document.getElementById(ulId);
  if (!ul) return;
  Array.from(ul.children).forEach(li => {
    const dateText = li.getAttribute('data-date') || li.textContent.trim();
    if (hasPassed(dateText)) li.classList.add('crossed');
  });
}
function refreshCrossedDates() {
  crossOffPastDates('cpiSchedule');
  crossOffPastDates('fedSchedule');
  crossOffPastDates('opexSchedule');
  crossOffPastDates('monthlyOpexSchedule');
  crossOffPastDates('holidaySchedule');
  crossOffPastDates('vixExpirySchedule');
}
document.addEventListener('DOMContentLoaded', () => {
  refreshCrossedDates();
  const now = new Date();
  const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 2);
  setTimeout(() => {
    refreshCrossedDates();
    setInterval(refreshCrossedDates, 24 * 60 * 60 * 1000);
  }, midnight - now);
});

/* ----------------- Date helpers ----------------- */
function todayLongUS() {
  return new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}
function isCpiDay() { return cpiSchedule.includes(todayLongUS()); }
function isFedDay() { return fedSchedule.includes(todayLongUS()); }
function isOpexDay() { return opexSchedule.includes(todayLongUS()); }
function isMonthlyOpexDay() { return monthlyOpexSchedule.includes(todayLongUS()); }
function isVixExpiryDay() { return vixExpirySchedule.includes(todayLongUS()); }

function isWeekend(d) { const day = d.getDay(); return day === 0 || day === 6; }
function isHoliday(d) {
  const asLong = d.toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
  return marketHolidays.includes(asLong);
}
function isTradingDay(d) {
  return !isWeekend(d) && !isHoliday(d);
}
function nextTradingDay(d) {
  const nd = new Date(d);
  do { nd.setDate(nd.getDate() + 1); } while (!isTradingDay(nd));
  return nd;
}
function prevTradingDay(d) {
  const pd = new Date(d);
  do { pd.setDate(pd.getDate() - 1); } while (!isTradingDay(pd));
  return pd;
}
function isSameYMD(a, b) {
  return a.getFullYear() === b.getFullYear()
      && a.getMonth() === b.getMonth()
      && a.getDate() === b.getDate();
}
function isTodayFirstTradingDayAfter(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  const after = nextTradingDay(d);
  const today = new Date();
  return isSameYMD(after, today);
}
function isPostHoliday() { return marketHolidays.some(isTodayFirstTradingDayAfter); }
function isPostQuarterlyOpexMonday() {
  const postAny = opexSchedule.some(isTodayFirstTradingDayAfter);
  return postAny && new Date().getDay() === 1;
}
function isPostMonthlyOpex() { return monthlyOpexSchedule.some(isTodayFirstTradingDayAfter); }

// Last trading day of month (EOM)
function lastTradingDayOfMonth(date = new Date()) {
  const y = date.getFullYear();
  const m = date.getMonth();
  let d = new Date(y, m + 1, 0); // last calendar day
  while (!isTradingDay(d)) d.setDate(d.getDate() - 1);
  return d;
}
function isLastTradingDayOfMonth(date = new Date()) {
  const last = lastTradingDayOfMonth(date);
  return isSameYMD(date, last);
}
function eomMinusN(date = new Date(), n = 1) {
  let d = lastTradingDayOfMonth(date);
  for (let i = 0; i < n; i++) d = prevTradingDay(d);
  return d;
}
function isEomMinus1Today() {
  const today = new Date();
  return isSameYMD(today, eomMinusN(today, 1));
}
function isEomMinus2Today() {
  const today = new Date();
  return isSameYMD(today, eomMinusN(today, 2));
}

// OPEX-1 (day before ANY OPEX: quarterly + monthly)
function isOpexMinus1Today() {
  const today = new Date();
  if (!isTradingDay(today)) return false;

  const allOpex = [...opexSchedule, ...monthlyOpexSchedule];
  return allOpex.some(opexStr => {
    const opexDate = new Date(opexStr);
    if (isNaN(opexDate)) return false;
    const opexMinus1 = prevTradingDay(opexDate);
    return isSameYMD(today, opexMinus1);
  });
}

/* ----------------- CPI UI ----------------- */
function updateCpiUI() {
  document.getElementById('yesterdayOpen').disabled = isCpiDay(); // disable Yesterday's Open on CPI days only
}
document.addEventListener('DOMContentLoaded', updateCpiUI);

document.getElementById('todayDate').textContent =
  "Today‚Äôs Date: " + new Date().toLocaleDateString();

/* ----------------- Calculator ----------------- */
function calculateStrategy() {
  const today = parseFloat(document.getElementById('todayOpen').value);
  const yOpen = parseFloat(document.getElementById('yesterdayOpen').value);
  const yClose = parseFloat(document.getElementById('yesterdayClose').value);

  if (isNaN(today) || isNaN(yClose) || (!isCpiDay() && isNaN(yOpen))) {
    alert("Please enter valid numbers.");
    return;
  }

  const cpiToday = isCpiDay();
  const fedToday = isFedDay();
  const opexToday = isOpexDay();
  const postQuarterlyOpexMonday = isPostQuarterlyOpexMonday();
  const postMonthlyOpex = isPostMonthlyOpex();
  const postHoliday = isPostHoliday();

  const eomToday = isLastTradingDayOfMonth(new Date());
  const eomMinus1Today = isEomMinus1Today();
  const eomMinus2Today = isEomMinus2Today();

  const opexMinus1Today = isOpexMinus1Today();

  const isMonday = new Date().getDay() === 1;
  const isFriday = new Date().getDay() === 5;
  const vixExpiryToday = isVixExpiryDay();

  // context tags
  document.getElementById('cpiTag').style.display = cpiToday ? 'inline-block' : 'none';
  document.getElementById('fedTag').style.display = fedToday ? 'inline-block' : 'none';
  document.getElementById('opexTag').style.display = opexToday ? 'inline-block' : 'none';
  document.getElementById('postOpexTag').style.display =
    (postQuarterlyOpexMonday || postMonthlyOpex) ? 'inline-block' : 'none';
  document.getElementById('postHolidayTag').style.display = postHoliday ? 'inline-block' : 'none';
  document.getElementById('eomTag').style.display = eomToday ? 'inline-block' : 'none';

  const openDiff = (isNaN(yOpen) ? NaN : yOpen - today); // ignored on CPI day
  const overnightDrop = yClose - today; // used on CPI + non-CPI

  // UI numbers
  document.getElementById('overnightDropDisplay').textContent =
    isNaN(overnightDrop) ? '‚Äî' : overnightDrop.toFixed(2);

  const openDiffDisplay = document.getElementById('openDiffDisplay');
  const openDiffNote = document.getElementById('openDiffNote');
  if (cpiToday) {
    openDiffDisplay.textContent = '‚Äî';
    openDiffNote.style.display = 'inline-block';
  } else {
    openDiffNote.style.display = 'none';
    openDiffDisplay.textContent = isNaN(openDiff) ? '‚Äî' : openDiff.toFixed(2);
  }

  let recommendationHTML = "";
  let bgColor = "#eee";

  if (cpiToday) {
    // CPI: use Yesterday‚Äôs Close ‚àí Today‚Äôs Open only (overnightDrop = yClose - todayOpen)
    if (overnightDrop < 0) {
      recommendationHTML = `<span class="crossed">Straddle @ 9:32 AM</span> ‚Üí No Trade (CPI day)`;
      bgColor = "#eee";
    } else {
      recommendationHTML = "Straddle @ 9:32 AM (CPI day)";
      bgColor = "#61f7d6";
    }
  } else {
    // BASE non-CPI logic ‚Äì GXBF has priority over open-to-open filter
    if (overnightDrop > 0.65) {
      recommendationHTML = "GXBF @ 9:36 AM";
      bgColor = "#fff399";
    } else if (openDiff > 1.4) {
      recommendationHTML = "M8 Butterfly";
      bgColor = "#b49aff";
    } else if (overnightDrop >= 0.01 && overnightDrop < 0.65) {
      recommendationHTML = "Straddle @ 9:32 AM";
      bgColor = "#61f7d6";
    } else {
      recommendationHTML = "M8 Butterfly";
      bgColor = "#b49aff";
    }

    // Fed-day: block M8 only (cross it)
    if (fedToday && /M8 Butterfly/.test(recommendationHTML)) {
      recommendationHTML = `<span class="crossed">M8 Butterfly</span> ‚Üí No Trade (Fed day)`;
      bgColor = "#eee";
    }

    // Day after market holiday: no M8 butterflies (cross it)
    if (postHoliday && /M8 Butterfly/.test(recommendationHTML)) {
      recommendationHTML = `<span class="crossed">M8 Butterfly</span> ‚Üí No Trade (day after market holiday)`;
      bgColor = "#eee";
    }

    // EOM override: force straddle (EOM Straddle)
    if (eomToday) {
      recommendationHTML = "Straddle @ 9:32 AM (EOM Straddle)";
      bgColor = "#61f7d6";
    }

    // Wednesday rule (not on CPI/Fed/EOM): if Straddle signal appears, take M8 instead
    const isWednesday = new Date().getDay() === 3;
    if (isWednesday && !fedToday && !cpiToday && !eomToday && /Straddle/.test(recommendationHTML)) {
      recommendationHTML = "M8 Butterfly";
      bgColor = "#b49aff";
    }

    // Post-OPEX timing hints (no weekday time list anymore)
    if (/M8 Butterfly/.test(recommendationHTML)) {
      if (postQuarterlyOpexMonday) {
        recommendationHTML = "M8 Butterfly (post-Quarterly OPEX Monday: use afternoon M8)";
      } else if (postMonthlyOpex) {
        recommendationHTML = "M8 Butterfly (post-OPEX: use morning M8)";
      }
    }
  }

  // Quarterly OPEX override: block Straddle (cross it)
  if (opexToday && /Straddle/.test(recommendationHTML)) {
    recommendationHTML = `<span class="crossed">${recommendationHTML}</span> ‚Üí No Trade (Quarterly OPEX)`;
    bgColor = "#eee";
  }

  // ---------- Unified block rendering ----------
  const recBlock = document.getElementById("recBlock");
  const mainRec = document.getElementById("mainRec");
  const bf1pmLine = document.getElementById("bf1pmLine");
  const bobfLine = document.getElementById("bobfLine");

  mainRec.innerHTML = `üëâ ${recommendationHTML}`;
  recBlock.style.backgroundColor = bgColor;

  /* ---------- 1PM BF signal ---------- 
     - in play only if Overnight VIX is up (today open > yesterday close) => overnightDrop < 0
     - block on Monday, VIX expiry, EOM, EOM-1
     - extra: if VIX Today‚Äôs Open < 16 => No 1PM BF (low VIX)
  */
  let bf1pmText = "1PM BF in play";
  if (!(overnightDrop < 0)) {
    bf1pmText = "No 1PM BF";
  } else if (today < 16) {
    bf1pmText = "No 1PM BF (low VIX)";
  } else if (isMonday) {
    bf1pmText = "No 1PM BF (Monday)";
  } else if (vixExpiryToday) {
    bf1pmText = "No 1PM BF (VIX expiration)";
  } else if (eomMinus1Today) {
    bf1pmText = "No 1PM BF (EOM-1)";
  } else if (eomToday) {
    bf1pmText = "No 1PM BF (EOM)";
  }

  bf1pmLine.innerHTML = bf1pmText.startsWith("No")
    ? `<span class="crossed">${bf1pmText}</span>`
    : bf1pmText;

  /* ---------- BOBF signal ----------
     - No BOBF on Fridays
     - No BOBF on VIX expiry days
     - No BOBF on EOM-2, EOM-1
     - No BOBF on OPEX-1 (day before any OPEX)
     - VIX range filter: min 15, max 23
  */
  let bobfText = "BOBF in play";

  if (today < 15 || today > 23) {
    bobfText = "No BOBF (VIX range)";
  } else if (eomMinus2Today) {
    bobfText = "No BOBF (EOM-2)";
  } else if (eomMinus1Today) {
    bobfText = "No BOBF (EOM-1)";
  } else if (opexMinus1Today) {
    bobfText = "No BOBF (OPEX-1)";
  } else if (isFriday) {
    bobfText = "No BOBF (Friday)";
  } else if (vixExpiryToday) {
    bobfText = "No BOBF (VIX expiration)";
  }

  bobfLine.innerHTML = bobfText.startsWith("No")
    ? `<span class="crossed">${bobfText}</span>`
    : bobfText;
}
</script>

</body>
</html>


