<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VIX Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
    button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
    .result { margin-top: 20px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    p { margin: 0.5em 0; }
  </style>
</head>
<body>
  <h1>ğŸ“ˆ VIX Dashboard</h1>
  <button onclick="fetchVIXData()">ğŸ”„ Update VIX Data</button>
  <div class="result" id="vixResults">Loading...</div>

  <script>
    const API_KEY = '2248f0c8a4de4025846b3093bdd1d641';

    async function fetchVIXData() {
      const resultsEl = document.getElementById("vixResults");
      resultsEl.innerText = "Fetching VIX data...";

      const today = new Date();
      const todayStr = today.toISOString().split("T")[0];

      const apiUrl = `https://api.twelvedata.com/time_series?symbol=VIX&interval=1min&outputsize=5000&apikey=${API_KEY}`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (!data.values) {
          resultsEl.innerText = `âŒ Error loading data: ${data.message || "Unknown error."}`;
          return;
        }

        const values = data.values;

        function findTime(dateStr, timeStr) {
          return values.find(v => v.datetime.startsWith(dateStr) && v.datetime.endsWith(timeStr));
        }

        // Find today's 9:30 AM open
        const todayOpen = findTime(todayStr, '09:30:00');
        if (!todayOpen) {
          resultsEl.innerText = `âš ï¸ Today's VIX open (9:30 AM) is not available yet.`;
          return;
        }

        const tOpenVal = parseFloat(todayOpen.open);

        // Find most recent past market day with both 9:30 and 16:00 values
        let backDays = 1;
        let yestDateStr = "";
        let yOpenVal, yCloseVal;
        let found = false;

        while (backDays <= 10 && !found) {
          const backDate = new Date(today);
          backDate.setDate(today.getDate() - backDays);
          const backStr = backDate.toISOString().split("T")[0];

          const yOpen = findTime(backStr, '09:30:00');
          const yClose = findTime(backStr, '16:00:00');

          if (yOpen && yClose) {
            yOpenVal = parseFloat(yOpen.open);
            yCloseVal = parseFloat(yClose.close);
            yestDateStr = backStr;
            found = true;
            break;
          }

          backDays++;
        }

        if (!found) {
          resultsEl.innerText = "âš ï¸ Could not find previous VIX open/close in last 10 days.";
          return;
        }

        const diffOpen = (yOpenVal - tOpenVal).toFixed(2);
        const diffClose = (yCloseVal - tOpenVal).toFixed(2);

        resultsEl.innerHTML = `
          <p><strong>ğŸ“… Today's Open (${todayStr} 9:30 AM):</strong> ${tOpenVal}</p>
          <p><strong>ğŸ“… Previous Market Day Used: ${yestDateStr}</strong></p>
          <p><strong>ğŸ•˜ Previous Open (9:30 AM):</strong> ${yOpenVal}</p>
          <p><strong>ğŸ•“ Previous Close (4:00 PM):</strong> ${yCloseVal}</p>
          <hr>
          <p><strong>ğŸ§® Previous Open - Today Open:</strong> ${diffOpen}</p>
          <p><strong>ğŸ§® Previous Close - Today Open:</strong> ${diffClose}</p>
        `;
      } catch (error) {
        resultsEl.innerText = "âŒ Network error or CORS blocked the request.";
        console.error(error);
      }
    }

    fetchVIXData();
  </script>
</body>
</html>
